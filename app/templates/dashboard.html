{% extends "__base__.html" %}

{% block page_style_post %}

<!-- Charts -->
<link rel="stylesheet" type="text/css" href="/static/normalize.css">
<link rel="stylesheet" type="text/css" href="/static/main.css">

<style>
#map-container {
        padding: 6px 6px 6px 6px;
        border-width: 1px;
        border-style: solid;
        border-color: #ccc #ccc #999 #ccc;
        -webkit-box-shadow: rgba(64, 64, 64, 0.5) 0 2px 5px;
        -moz-box-shadow: rgba(64, 64, 64, 0.5) 0 2px 5px;
        box-shadow: rgba(64, 64, 64, 0.1) 0 2px 5px;
        width: 600px;
      }

#map {
  width: 600px;
  height: 400px;
  }

{% for item in NOI_COLORS %}
.noi-color{{loop.index}}:before { background-color: {{item}}; }
{% endfor %}

.top-buffer { margin-top:20px; }

</style>
{% endblock %}

{% block content %}

<div class="container">
<div class="b-content-header">
  <h1>Location of Attendees</h1>
  <h2>{{ALL_USERS|length}} people are sharing their profile and expertise</h2>
</div>


  <div class="row">

    <div class="col-md-8">
      <h2></h2>

      <div id="map-container">
        <div id="map"></div>
      </div>
    </div>

  <div class="col-md-4">
    <h2>Attendees Occupation</h2>
    <div style="margin-top: 100px;"></div>
    <div id="container-attendees-occupation">
      <canvas id="attendees-occupation"></canvas>
      <div class="chart-legend">
        <ul>
          {% for item in OCCUPATIONS %}
          <li class="noi-color{{loop.index}}">{{item['org_type']}}</li>
          {% endfor %}
        </ul>
      </div>
    </div>
  </div>
  <script>
  var userOccupations = {{OCCUPATIONS|tojson}};  
  var attendeesOccupationData = [
    {% for item in OCCUPATIONS %}
      { 'value': {{item['cnt']}}, 'color': '{{NOI_COLORS[loop.index-1]}}' },
    {% endfor %}
      ];
  function showAttendeesOccupation() {
    var canvas = document.getElementById('attendees-occupation');
    var ctx = canvas.getContext('2d');
    new Chart(ctx).Doughnut(attendeesOccupationData);
  }
  </script>

  </div>

</div>

{% endblock %}

{% block page_script %}

<!-- Google Maps Cluster Map -->
<script src="http://maps.google.com/maps/api/js?sensor=false"></script>
<script src="http://google-maps-utility-library-v3.googlecode.com/svn/tags/markerclustererplus/2.1.2/src/markerclusterer.js"></script>

<!-- Charts -->
<script src="/static/plugins.js"></script>
<script src="/static/main.js"></script>

<script>

// We load the data from the database.
  {% if ALL_USERS is defined %}
var data = {{ALL_USERS|tojson}};
  {% else %}
var data = [];
  {% endif %}

// Utility function to parse latlng string from database.
function latLngFromString(str) {
  var arr = str.slice(1,-1).split(',');
  return new google.maps.LatLng(arr[0], arr[1]);
}

function displayMap() {
  console.log('Inside displayMap.');
  var mapOptions = { 'zoom': 2,
                   'center': new google.maps.LatLng(45.424196,-75.691188),
                   'mapTypeId': google.maps.MapTypeId.ROADMAP };
  var map = new google.maps.Map(document.getElementById('map'), mapOptions);
  
  var markerClusterer = null;
  var imageUrl = 'http://chart.apis.google.com/chart?cht=mm&chs=24x32&chco=FFFFFF,008CFF,000000&ext=.png';
  var markers = [];
  for (var i = 0; i < data.length; i++) {
    var markerData = { position: latLngFromString(data[i].latlng),
                       title: data[i].first_name + ' ' + data[i].last_name };
    var marker = new google.maps.Marker(markerData);
    markers.push(marker);
  }
  var markerImage = new google.maps.MarkerImage(imageUrl, new google.maps.Size(24, 32));
  var options = {maxZoom: null, gridSize: null, styles: null};
  markerClusterer = new MarkerClusterer(map, markers, options);
}

google.maps.event.addDomListener(window, 'load', displayMap);

$( document ).ready(function() {
  showAttendeesOccupation();
});

</script>
{% endblock %}