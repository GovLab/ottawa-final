{% extends "__base__.html" %}

{% block title %}My Profile{% endblock %}

{% block page_style_pre %}
  <link rel="stylesheet" href="/static/chosen_v1.4.2/docsupport/style.css">
  <link rel="stylesheet" href="/static/chosen_v1.4.2/docsupport/prism.css">
  <link rel="stylesheet" href="/static/chosen_v1.4.2/chosen.css">
  <style>
  .noi-button { margin-top: 20px; margin-left: 20px;}
  .selector { margin-top: 20px; margin-left: 20px;}
  ol ul li, ul ul li {
  list-style-type: none;
  margin: initial;
}
ul li {
  list-style: initial;
  margin-left: initial;
  margin-bottom: initial;
}
  </style>
{% endblock %}

{% block page_style_post %}
{% endblock %}

{% block content %}

<div class="form-horizontal">

<input id="q-userid" name="userid" type="hidden" value="{{session['social-login']['userid']}}">
<input id="q-picture" name="picture" type="hidden" value="{{session['social-login']['picture']}}">

<fieldset>

<!-- Form Name -->
<legend>Some core information about you</legend>

<!-- Given Name -->
<div class="form-group">
  <label class="col-md-4 control-label" for="textinput">First Name</label>  
  <div class="col-md-4">
  <input id="q-first_name" name="first_name" type="text" placeholder="placeholder" class="form-control input-md">
  <span class="help-block">help</span>  
  </div>
</div>

<!-- Family Name -->
<div class="form-group">
  <label class="col-md-4 control-label" for="textinput">Last Name</label>  
  <div class="col-md-4">
  <input id="q-last_name" name="last_name" type="text" placeholder="placeholder" class="form-control input-md">
  <span class="help-block">help</span>  
  </div>
</div>

<!-- Email-->
<div class="form-group">
  <label class="col-md-4 control-label" for="textinput">Email</label>  
  <div class="col-md-4">
  <input id="q-email" name="email" type="text" placeholder="placeholder" class="form-control input-md">
  <span class="help-block">help</span>  
  </div>
</div>
</fieldset>

<!-- Position -->
<div class="form-group">
  <label class="col-md-4 control-label" for="textinput">Position</label>  
  <div class="col-md-4">
  <input id="q-title" name="title" type="text" placeholder="placeholder" class="form-control input-md">
  <span class="help-block">help</span>  
  </div>
</div>

<!-- Org -->
<div class="form-group">
  <label class="col-md-4 control-label" for="textinput">Organization</label>  
  <div class="col-md-4">
  <input id="q-org" name="org" type="text" placeholder="placeholder" class="form-control input-md">
  <span class="help-block">help</span>  
  </div>
</div>

<!-- Location > City -->
<div class="form-group">
  <label class="col-md-4 control-label" for="textinput">Location (City)</label>  
  <div class="col-md-4">
  <input id="q-city" name="city" type="text" placeholder="placeholder" class="form-control input-md">
  <span class="help-block">help</span>  
  </div>
</div>

<!-- Location > Country -->
<div class="form-group">
  <label class="col-md-4 control-label" for="textinput">Location (Country)</label>  
  <div class="col-md-4">
  <div class="selector">
      <select id="q-country" name="country" data-placeholder="Choose a Country..." class="chosen-select" style="width:350px;" tabindex="2">
        <option value=""></option>
        {% for country in COUNTRIES %}
        <option value="{{country}}">{{country}}</option>
        {% endfor %}
      </select>
    </div>
<!--   <input id="q-country" name="country" type="text" placeholder="placeholder" class="form-control input-md"> -->
  <span class="help-block">help</span>  
  </div>
</div>

<!-- Domain Expertise -->
<div class="form-group">
  <label class="col-md-4 control-label" for="textarea">Domain Expertise</label>
  <div class="col-md-4">                     
    <textarea class="form-control" id="q-domain_expertise" name="domain-expertise">default text</textarea>
    <span class="help-block">help</span>  
  </div>
</div>

<!-- Languages -->
<div class="form-group">
  <label class="col-md-4 control-label" for="selectmultiple">Language(s)</label>
  <div class="col-md-4 selector">
    <select id="q-langs" name="langs" multiple class=" chosen-select form-control">
      {% for item in LANGS %}
      <option value="{{item}}">{{item}}</option>
      {% endfor %}
    </select>
    <span class="help-block">The languages you speak.</span>  
  </div>
</div>
</div>

<center>
  <form id="me-form" class="form-horizontal" method="POST" action="/me">
  <button id="save-profile" type="button">Save</button>
  <input id="me-as-json" type="hidden" name="me"/>
  </form>  
</center>



{% endblock %}

{% block page_script %}

<script src="/static/chosen_v1.4.2/chosen.jquery.js" type="text/javascript"></script>
<script src="/static/chosen_v1.4.2/docsupport/prism.js" type="text/javascript" charset="utf-8"></script>

<script type="text/javascript">
    var config = {
      '.chosen-select'           : {},
      '.chosen-select-deselect'  : {allow_single_deselect:true},
      '.chosen-select-no-single' : {disable_search_threshold:10},
      '.chosen-select-no-results': {no_results_text:'Oops, nothing found!'},
      '.chosen-select-width'     : {width:"95%"}
    }
    for (var selector in config) {
      $(selector).chosen(config[selector]);
    }
</script>

<script>
{% if userProfile %}
var userProfile = {{userProfile|tojson}};
{% else %}
var userProfile = null;
{% endif %} 

if (userProfile == null) {
  // We populate some fields using the social-login.
  var user = {{session['social-login']|tojson}};
  $.each(['first_name', 'last_name'], function(i, v) {
	 $('#q-' + v).val(user[v]);
  });
} else {
  console.log('userProfile is not null.');
  // We populate the form based on the data.
  $('input[id*="q-"]').map(function() { $(this).attr('value', userProfile[$(this).attr('id').substring(2)]) } );
  $('textarea[id*="q-"]').map(function() { $(this).text(userProfile[$(this).attr('id').substring(2)]) } );
  $('select[id="q-langs"]').children('option').map(function() {
    if ($.inArray($(this).attr('value'), userProfile.langs) > -1) {
      console.log('Match for ' + $(this).attr('value'));
      $(this).attr('selected', '');
  } else {
    $(this).removeAttr('selected');
  }
  });
  $('#q-langs').trigger("chosen:updated");  // We need to update the UI.

$('select[id="q-country"]').children('option').map(function() {
    if ($(this).attr('value') == userProfile.country) {
      console.log('Match for ' + $(this).attr('value'));
      $(this).attr('selected', '');
  } else {
    $(this).removeAttr('selected');
  }
  });
  $('#q-country').trigger("chosen:updated");  // We need to update the UI.

}

$('#save-profile').click(function() {
  // We build a JSON object for the form.
  var profileData = {};
  
  // <input> attributes
  $.each($('input[id*="q-"]'), function(i, v) {
    profileData[$(v).attr('id').substring(2)] = $(v).val();
  });
  
  // <textarea attributes
  $.each($('textarea[id*="q-"]'), function(i, v) {
    profileData[$(v).attr('id').substring(2)] = $(v).val();
  });
  
  // langs
  profileData['langs'] = $('select[id="q-langs"]').children(':checked').toArray().map(function(v, i) { return v['value']; });
  profileData['country'] = $('select[id="q-country"]').children(':checked').val();
  // DOES NOT WORK!: TypeError: Converting circular structure to JSON
  // profileData['langs'] = $('select[id="q-langs"]').children(':checked').map(function(i, v) { return $(v).val() });  

  console.log(profileData);
  $('#me-as-json').attr('value', JSON.stringify(profileData));
  $('#me-form').submit();
});

</script>
{% endblock %}
